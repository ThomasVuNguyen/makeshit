<mujoco model="BeeWalker">
  <compiler angle="degree" coordinate="local" inertiafromgeom="true"/>
  <option timestep="0.002" gravity="0 0 -9.81"/>

  <default>
    <joint armature="0.01" damping="0.5" limited="true"/>
    <geom condim="3" friction="1.0 0.5 0.5" margin="0.001"/>
    <motor ctrlrange="-1.57 1.57" ctrllimited="true"/> 
    
    <!-- COMPONENTS -->
    <default class="servo_case">
        <geom type="box" size="0.02 0.01 0.02" rgba="0.1 0.1 0.1 1" mass="0.055"/>
    </default>
    <default class="servo_horn">
        <geom type="cylinder" size="0.01 0.003" rgba="0.8 0.8 0.8 1" mass="0.005"/>
    </default>
    
    <!-- BRACKETS (Generic Plate) -->
    <default class="plate">
        <geom type="box" size="0.002 0.02 0.03" rgba="0.6 0.2 0.8 1" mass="0.01"/>
    </default>
    
    <!-- FOOT -->
    <default class="foot_plate">
        <geom type="box" size="0.015 0.02 0.002" rgba="0.9 0.8 0.1 1" mass="0.03"/>
    </default>
    
    <!-- TORSO/HEAD BODY -->
    <default class="torso_body">
        <geom type="box" size="0.03 0.04 0.04" rgba="0.9 0.8 0.1 1" mass="0.2"/>
    </default>
  </default>

  <asset>
    <texture type="skybox" builtin="gradient" rgb1=".3 .5 .7" rgb2="0 0 0" width="32" height="32"/>
    <texture name="grid" type="2d" builtin="checker" width="512" height="512" rgb1=".1 .2 .3" rgb2=".2 .3 .4"/>
    <material name="grid" texture="grid" texrepeat="1 1" texuniform="true" reflectance=".2"/>
  </asset>

  <worldbody>
    <light pos="0 0 10" dir="0 0 -1" castshadow="true"/>
    <geom name="floor" type="plane" size="2 2 0.1" material="grid"/>

    <!-- 
      NEW TOPOLOGY: The "pelvis" is the root body that floats.
      The torso (head/body) sits ON TOP of the pelvis.
      The legs hang DOWN from the pelvis.
      
      This matches the physical robot where the yellow body is carried 
      on top of the leg structure.
    -->
    
    <!-- Pelvis/Hip Base - This is the floating root -->
    <body name="pelvis" pos="0 0 0.25">
      <freejoint/>
      
      <!-- Pelvis structure - the base that connects both hip servos -->
      <geom name="pelvis_base" type="box" size="0.02 0.04 0.015" rgba="0.6 0.2 0.8 1" mass="0.05"/>
      
      <!-- TORSO/HEAD sits ON TOP of the pelvis -->
      <body name="torso" pos="0 0 0.055">
        <geom class="torso_body"/>
        <!-- Eyes/Front indicator -->
        <geom type="cylinder" size="0.005 0.005" pos="0.03 0.02 0.02" euler="0 90 0" rgba="0 0 0 1"/>
        <geom type="cylinder" size="0.005 0.005" pos="0.03 -0.02 0.02" euler="0 90 0" rgba="0 0 0 1"/>
        <!-- IMU sensor site (MPU-6050 location) -->
        <site name="imu_site" pos="0 0 0" size="0.005"/>
      </body>

      <!-- ================= LEFT LEG (Y+) ================= -->
      <!-- Hip servo mounted at the bottom of pelvis, leg goes DOWN -->
      <body name="left_hip_structure" pos="0 0.035 -0.015">
          
          <!-- HIP SERVO: Mounted horizontally, horn points OUT (+Y) -->
          <geom class="servo_case" euler="90 0 0"/> 
          <geom class="servo_horn" pos="0 0.015 0" euler="90 0 0"/>
          
          <body name="left_thigh" pos="0 0 0">
            <!-- PITCH JOINT - rotates around Y axis (pitch forward/backward) -->
            <joint name="left_hip_joint" type="hinge" axis="0 1 0" range="-90 90"/>
            
            <!-- BRACKET: Connects to Horn, extends DOWN -->
            <!-- Outer Plate (attached to horn) -->
            <geom class="plate" pos="0 0.018 -0.03" size="0.01 0.002 0.03"/>
            <!-- Inner Plate (holding next servo) -->
            <geom class="plate" pos="0 -0.018 -0.03" size="0.01 0.002 0.03"/>
            <!-- Connecting Plate (Bottom) -->
            <geom class="plate" pos="0 0 -0.06" size="0.01 0.02 0.002"/>

            <!-- KNEE SERVO: Mounted between brackets -->
            <body name="left_knee_structure" pos="0 0 -0.065">
                <geom class="servo_case" euler="90 0 0"/>
                <geom class="servo_horn" pos="0 0.015 0" euler="90 0 0"/>
                
                <body name="left_shin" pos="0 0 0">
                    <joint name="left_knee_joint" type="hinge" axis="0 1 0" range="-90 90"/>
                    
                    <geom class="plate" pos="0 0.018 -0.03" size="0.01 0.002 0.03"/>
                    <geom class="plate" pos="0 -0.018 -0.03" size="0.01 0.002 0.03"/>
                    <geom class="plate" pos="0 0 -0.06" size="0.01 0.02 0.002"/>
                    
                    <body name="left_ankle_structure" pos="0 0 -0.065">
                         <geom class="servo_case" euler="90 0 0"/>
                         <geom class="servo_horn" pos="0 0.015 0" euler="90 0 0"/>
                         
                         <body name="left_foot" pos="0 0 0">
                            <joint name="left_ankle_joint" type="hinge" axis="0 1 0" range="-45 45"/>
                            <geom class="foot_plate" pos="0 0 -0.015"/>
                         </body>
                    </body>
                </body>
            </body>
          </body>
      </body>

      <!-- ================= RIGHT LEG (Y-) ================= -->
      <body name="right_hip_structure" pos="0 -0.035 -0.015">
          
          <!-- HIP SERVO: Horn faces OUT (-Y) -->
          <geom class="servo_case" euler="90 0 0"/>
          <geom class="servo_horn" pos="0 -0.015 0" euler="90 0 0"/>
          
          <body name="right_thigh" pos="0 0 0">
            <joint name="right_hip_joint" type="hinge" axis="0 1 0" range="-90 90"/>
            
            <!-- Outer Plate (on Horn -Y) -->
            <geom class="plate" pos="0 -0.018 -0.03" size="0.01 0.002 0.03"/>
            <!-- Inner Plate -->
            <geom class="plate" pos="0 0.018 -0.03" size="0.01 0.002 0.03"/>
            <geom class="plate" pos="0 0 -0.06" size="0.01 0.02 0.002"/>

            <body name="right_knee_structure" pos="0 0 -0.065">
                <geom class="servo_case" euler="90 0 0"/>
                <geom class="servo_horn" pos="0 -0.015 0" euler="90 0 0"/>
                
                <body name="right_shin" pos="0 0 0">
                    <joint name="right_knee_joint" type="hinge" axis="0 1 0" range="-90 90"/>
                    
                    <geom class="plate" pos="0 -0.018 -0.03" size="0.01 0.002 0.03"/>
                    <geom class="plate" pos="0 0.018 -0.03" size="0.01 0.002 0.03"/>
                    <geom class="plate" pos="0 0 -0.06" size="0.01 0.02 0.002"/>
                    
                    <body name="right_ankle_structure" pos="0 0 -0.065">
                         <geom class="servo_case" euler="90 0 0"/>
                         <geom class="servo_horn" pos="0 -0.015 0" euler="90 0 0"/>
                         
                         <body name="right_foot" pos="0 0 0">
                            <joint name="right_ankle_joint" type="hinge" axis="0 1 0" range="-45 45"/>
                            <geom class="foot_plate" pos="0 0 -0.015"/>
                         </body>
                    </body>
                </body>
            </body>
          </body>
      </body>

    </body>
  </worldbody>

  <actuator>
    <!-- MG996R Servo Simulation:
         - Operating speed: 0.17s/60Â° = ~6.1 rad/s max
         - Stall torque: 11 kg.cm = ~1.08 Nm
         - Using dyntype=filter with 20ms time constant for realistic response -->
    <general name="servo_left_hip" joint="left_hip_joint" 
             gainprm="50 0 0" biasprm="0 -50 0"
             dyntype="filter" dynprm="0.02"
             ctrllimited="true" ctrlrange="-1.57 1.57"
             forcelimited="true" forcerange="-1.1 1.1"/>
    <general name="servo_left_knee" joint="left_knee_joint" 
             gainprm="50 0 0" biasprm="0 -50 0"
             dyntype="filter" dynprm="0.02"
             ctrllimited="true" ctrlrange="-1.57 1.57"
             forcelimited="true" forcerange="-1.1 1.1"/>
    <general name="servo_left_ankle" joint="left_ankle_joint" 
             gainprm="50 0 0" biasprm="0 -50 0"
             dyntype="filter" dynprm="0.02"
             ctrllimited="true" ctrlrange="-1.57 1.57"
             forcelimited="true" forcerange="-1.1 1.1"/>
    <general name="servo_right_hip" joint="right_hip_joint" 
             gainprm="50 0 0" biasprm="0 -50 0"
             dyntype="filter" dynprm="0.02"
             ctrllimited="true" ctrlrange="-1.57 1.57"
             forcelimited="true" forcerange="-1.1 1.1"/>
    <general name="servo_right_knee" joint="right_knee_joint" 
             gainprm="50 0 0" biasprm="0 -50 0"
             dyntype="filter" dynprm="0.02"
             ctrllimited="true" ctrlrange="-1.57 1.57"
             forcelimited="true" forcerange="-1.1 1.1"/>
    <general name="servo_right_ankle" joint="right_ankle_joint" 
             gainprm="50 0 0" biasprm="0 -50 0"
             dyntype="filter" dynprm="0.02"
             ctrllimited="true" ctrlrange="-1.57 1.57"
             forcelimited="true" forcerange="-1.1 1.1"/>
  </actuator>

  <sensor>
    <!-- IMU sensors (simulating MPU-6050) -->
    <accelerometer name="imu_accel" site="imu_site"/>
    <gyro name="imu_gyro" site="imu_site"/>
    <!-- Additional sensors for observations -->
    <framequat name="pelvis_orientation" objtype="body" objname="pelvis"/>
    <frameangvel name="pelvis_angvel" objtype="body" objname="pelvis"/>
    <framexaxis name="pelvis_xaxis" objtype="body" objname="pelvis"/>
  </sensor>

</mujoco>
